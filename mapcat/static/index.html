
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mapcat Map</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <style>
        #map { width: 100vw; height: 100vh; margin: 0; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
    // Minimal Leaflet map
    var map = L.map('map').setView([52.527913, 13.416302], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    // WebSocket client
    var ws_url = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws';
    var ws = new WebSocket(ws_url);

    ws.onopen = function() {
        console.log('WebSocket connected');
    };
    ws.onclose = function() {
        console.log('WebSocket disconnected');
    };
    ws.onerror = function(e) {
        console.error('WebSocket error', e);
    };

    // Feature rendering
    function renderFeature(msg) {
        // Example: {cmd: "add-point", coords: [[lat, lng]], params: {color: "red"}}
        if (!msg || !msg.cmd) return;
        if (msg.cmd === 'add-point' && Array.isArray(msg.coords)) {
            msg.coords.forEach(function(coord) {
                L.circleMarker(coord, {
                    radius: 8,
                    color: msg.params?.color || '#007cff',
                    fillColor: msg.params?.color || '#007cff',
                    fillOpacity: 0.7,
                    weight: 2
                }).addTo(map);
            });
        } else if (msg.cmd === 'add-polyline' && Array.isArray(msg.coords)) {
            L.polyline(msg.coords, {
                color: msg.params?.color || '#ff0000',
                weight: 5,
                opacity: 0.7
            }).addTo(map);
        } else if (msg.cmd === 'add-polygon' && Array.isArray(msg.coords)) {
            L.polygon(msg.coords, {
                color: msg.params?.color || '#28a745',
                fillOpacity: 0.3
            }).addTo(map);
        } else if (msg.cmd === 'clear') {
            map.eachLayer(function(layer) {
                if (layer instanceof L.CircleMarker || layer instanceof L.Polyline || layer instanceof L.Polygon) {
                    map.removeLayer(layer);
                }
            });
        }
    }

    ws.onmessage = function(event) {
        try {
            var msg = JSON.parse(event.data);
            renderFeature(msg);
        } catch (e) {
            console.warn('Invalid message', event.data);
        }
    };
    </script>
</body>
</html>
